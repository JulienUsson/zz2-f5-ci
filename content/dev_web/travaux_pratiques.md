---
title: "TP n¬∞4 Le developpement web"
weight: 2
---

Lors de ce TP, nous allons commencer le d√©veloppement du jeu **Jaipur**. Dans un premier temps, je vous propose de lire les [r√®gles](/jaipur/travaux_pratiques/#r%C3%A8gles).

## R√©cup√©ration du projet

Le projet est disponible sur [Github](https://github.com/JulienUsson/jaipur-backend-starter). Il faut [forker](https://docs.github.com/en/get-started/quickstart/fork-a-repo#forking-a-repository) le projet ce qui va cr√©er une copie du d√©p√¥t vous appartenant.

Maintenant que vous avez votre copie, il suffit de la t√©l√©charger sur votre ordinateur via la commande `git clone https://github.com/YOUR-USERNAME/YOUR-REPOSITORY` [[aide]](https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/cloning-a-repository-from-github/cloning-a-repository#cloning-a-repository).

## D√©marrage du projet

Je vous conseille d'utiliser [Visual Studio Code](/annexes/vscode/) lors de vos d√©veloppement.

Une fois le projet ouvert, ouvrez un terminal depuis *code* (Menu Terminal -> New Terminal) puis installer les d√©pendances *Node* via la commande `npm install`.
Un r√©pertoire *node_modules* a √©t√© cr√©√© contenant l'ensemble des d√©pendances de l'application.

Il suffit maintenant d'utiliser la commande `npm run start` pour d√©marrer l'application. Rendez-vous sur [`http://localhost:3000/health`](http://localhost:3000/health) et le message `{ health: "ok" }` devrait s'afficher confirmant le bon fonctionnement du site üéâ.

‚ÑπÔ∏è Si le port est d√©j√† pris (tr√®s probable sur les machines de l'ISIMA), vous pouvez utiliser `PORT=xxxx npm run start` pour d√©marrer l'application sur le port `xxxx`.


## Cr√©ation d'une partie

Lors de ce tp nous allons d√©velopper notre premi√®re fonctionnalit√© : **En tant que joueur, je peux cr√©er une partie** [[voir]](http://localhost:1313/jaipur/travaux_pratiques/#en-tant-que-joueur-je-peux-cr%C3%A9er-une-partie-tp4). Toutes les fonctions de notre application seront li√©es √† des routes HTTP qui sont list√© dans la [sp√©cification](/jaipur/travaux_pratiques/#sp√©cification-de-lapi). Gr√¢ce a cela, tous les tp fonctionneront de la m√™me fa√ßon et la m√™me application frontend fonctionera avec chacun de vos backend.


Avant de commencer √† d√©velopper, il est important de **toujours** travailler dans une branche. Pour cela nous allons cr√©er une branche `feature/create-game` avec la commande `git branch feature/create-game` puis nous d√©placer dessus avec la commande `git checkout feature/create-game`. N'h√©sitez pas √† d√©couper votre travail en plusieurs commits. Pour rappel, les commits doivent √™tre **atomique** avec une description **claire**.


La sp√©cification de la route qui permet de cr√©er une partie est disponible [ici](https://jaipur-api.usson.me/#api-Game-createGame). 

![sp√©cification](/dev_web/swagger.png)

Essayons de la comprendre. Premi√®rement, on peut remarquer que l'adresse de notre route est `/games` et qu'elle r√©pond au verbe HTTP `POST`. Ensuite, notre route prend en entr√©e (via son corps) un objet json qui contient une propri√©t√© name qui est une cha√Æne de caract√®res.
 La r√©ponse attendu est un statut 201 qui signifie `created`. Le message contenu dans la r√©ponse est un objet repr√©sentant une `game`. Pour savoir comment initialiser un objet `game`, il faut lire les [r√®gles](/jaipur/travaux_pratiques/#r%C3%A8gles). Comme vous l'avez remarqu√© (ou pas), l'objet `game` manque d'informations car la sp√©cification d√©finit le minimum pour que le frontend fonctionne. Je vous conseille d'utiliser la structure suivante pour votre objet `game`.

{{< highlight JavaScript >}}
{
    // identifiant de la partie
    "id": 1,
    "name": "nom de la partie",
    // pioche
    "_deck": ["diamond", "camel", "cloth", "cloth", ...],
    // march√©
    "market": ["camel", "camel", "camel", "cloth", "gold"],
    "_players": [
        {
            // main
            "hand": ["cloth", "silver", "diamonds"],
            // nombre de chameaux
            "camelsCount": 2, 
            // Score actuel
            "score": 0,
        },
        {
            "hand": ["gold", "gold", "leather", "diamonds", "spice"],
            "camelsCount": 0,
            "score": 0,
        }
    ],
    // joueur courant (0 ou 1)
    "currentPlayerIndex": 0,
    "tokens": {
        "diamonds": [7,7,5,5,5],
        "gold": [6,6,5,5,5],
        "silver": [5,5,5,5,5],
        "cloth": [5,3,3,2,2,1,1],
        "spice": [5,3,3,2,2,1,1],
        "leather": [4,3,2,1,1,1,1,1,1],
    },
    // ne pas oublier de les m√©langer au d√©but de la partie
    "_bonusTokens": {
        "3": [2,1,2,3,1,2,3],
        "4": [4,6,6,4,5,5],
        "5": [8,10,9,8,10]
    },
    // est-ce que la partie est termin√©e?
    "isDone": false
}
{{< /highlight >}}

> A votre avis, pourquoi ces propri√©t√©s ne sont pas dans la sp√©cification et quel est l'int√™ret de les pr√©fixer par un `_` ?

## Let's code

Premi√®rement il faut cr√©er un nouveau router qui va g√©rer les routes commencent par `/games`.

`/src/routes/gameRouter.js`
{{< highlight javascript >}}
import express from "express"
import * as gameService from "../services/gameService"

const router = express.Router()

// Listen to POST /games
router.post("/", function (req, res) {
  const newGame = gameService.createGame(req.params.name)
  res.status(201).json(newGame)
})

export default router
{{< /highlight >}}

`/src/routes/index.js`
{{< highlight javascript >}}
import express from "express"

import healthRouter from "./healthRouter"
import gameRouter from "./gameRouter"

const router = express.Router()

router.use("/health", healthRouter)
router.use("/games", gameRouter)

export default router
{{< /highlight >}}

La bonne pratique lorsque l'on d√©veloppe des routes est d'√©crire notre code m√©tier dans des fichier de service. Toute l'intelligence de notre application sera contenu dans des services et nos routes seront le plus b√™te possible et ne feront qu'appeler des services.

Utiliser le squelette du service `gameService` ci-dessous pour d√©velopper votre premi√®re fonctionnalit√©.

`/src/services/gameService.js`
{{< highlight javascript >}}
import fs from "fs"
import path from "path"
import _ from "lodash"

const DATABASE_FILE = path.join(__dirname, "../../storage/database.json")

// Read the file storage/database.json and return the parsed array of games.
export function getGames() {
  try {
    const file = fs.readFileSync(DATABASE_FILE)
    return JSON.parse(file)
  } catch (e) {
    return []
  }
}

// Save a game to storage/database.json
export function saveGame(game) {
  const games = getGames()
  const gameIndex = games.findIndex((g) => g.id === game.id)
  if (gameIndex >= 0) {
    games[gameIndex] = game
  } else {
    games.push(game)
  }
  try {
    fs.mkdirSync(path.dirname(DATABASE_FILE))
  } catch (e) {
    // Do nothing
  }
  fs.writeFileSync(path.join(DATABASE_FILE), JSON.stringify(games))
}

// Return a shuffled deck
function initDeck() {
  // TODO
  return []
}

// Draw {count} cards of a deck
function drawCards(deck, count = 1) {
  // TODO
}

// Transfer camels from players hand (_players[i].hand) to their herd (_players[i].camelsCount)
function putCamelsFromHandToHerd(game) {
  // TODO
}

// Create a game object
export function createGame(name) {
  // TODO
  return {}
}
{{< /highlight >}}

‚ÑπÔ∏è Pour tester vos routes, il est **recommand√©** d'utiliser le logiciel [Postman](https://cours.usson.me/annexes/postman/).

‚ÑπÔ∏è Les parties sont sauvegard√©s sous forme d'un tableau de parties dans le fichier `storage/database.json`.

‚ÑπÔ∏è Pour g√©n√©rer l'identifiant, il suffit de r√©cup√©rer le nombre de parties sauvegard√©es et d'y ajouter 1.

‚ÑπÔ∏è [shuffle()](https://lodash.com/docs/4.17.15#shuffle) permet de m√©langer un tableau.

‚ÑπÔ∏è [fs.readFileSync()](https://nodejs.org/api/fs.html#fs_fs_readfilesync_path_options) permet de lire une **string** d'un fichier.

‚ÑπÔ∏è [fs.writeFileSync()](https://nodejs.org/api/fs.html#fs_fs_writefilesync_file_data_options) permet d'√©crire une **string** dans un fichier.

‚ÑπÔ∏è [JSON.stringify()](https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/JSON/stringify) permet de convertir un **objet** Javascript en **string**.

‚ÑπÔ∏è [JSON.parse()](https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/JSON/parse) permet de convertir une **string** en **objet** Javascript.

‚ÑπÔ∏è [path.join()](https://nodejs.org/api/path.html#path_path_join_paths) permet de concatener des chemins de fichier.
